<%@ page import="java.sql.*, java.text.SimpleDateFormat,java.util.ArrayList, java.util.List" %>
<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<%
    // --- 1. Í∏∞Î≥∏ Ï†ïÎ≥¥ Î∞è ÌååÎùºÎØ∏ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞ ---
    if (session.getAttribute("userId") == null) {
        response.sendRedirect("login.jsp");
        return;
    }
    String nickname = (String) session.getAttribute("nickname");
    Integer memberIdx = (Integer) session.getAttribute("memberIdx");
    String selectedCategoryId_str = request.getParameter("categoryId");
    String selectedMemoId_str = request.getParameter("memoId");
    //Ïπ¥ÌÖåÍ≥†Î¶¨ Î™©Î°ù 
    List<String[]> categoryList=new ArrayList<>();
    
    Connection con = null;
    PreparedStatement pstmt = null;
    ResultSet rs = null;
    Class.forName("org.mariadb.jdbc.Driver");
    con = DriverManager.getConnection("jdbc:mariadb://localhost:3306/memodb", "admin", "1234");
    try {
    	String sql = "SELECT l.idx, l.listName, COUNT(m.idx) as memo_count " +
                "FROM list AS l LEFT JOIN memo AS m ON l.idx = m.list_idx " +
                "WHERE l.member_idx = ? " +
                "GROUP BY l.idx, l.listName ORDER BY l.listName";
        pstmt = con.prepareStatement(sql);
        pstmt.setInt(1, memberIdx);
        rs = pstmt.executeQuery();
        while(rs.next()) {
        	categoryList.add(new String[]{ 
                    rs.getString("idx"), 
                    rs.getString("listName"), 
                    rs.getString("memo_count") 
                });
        }
    } catch (Exception e) {
        e.printStackTrace();
    } finally {
        if (rs != null) try { rs.close(); } catch (Exception e) {}
        if (pstmt != null) try { pstmt.close(); } catch (Exception e) {}
    }
    
%>
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Î©îÎ™® ÌîÑÎ°úÍ∑∏Îû®</title>
    <style>
        .memo_titles { margin-left: 20px; margin-bottom: 6px; }
        .memo_title_item { padding: 4px 8px; cursor: pointer; }
        .memo_title_item:hover { background-color: #f0f0f0; }
        * { box-sizing: border-box; font-family: "Arial", sans-serif; }
        header { display: flex; justify-content: space-between; align-items: center; height: 40px; }
        header h1 { margin: 0; font-size: 30px; }
        header h1 a { text-decoration: none; color: #f44336; }
        .layout { display: flex; height: 100vh; }
        .left { width: 15%; background-color: #fff; border-right: 2px solid #bbb; padding: 5px; }
        .user_info { margin-bottom: 20px; border: 1px solid #ccc; border-radius: 8px; text-align: center; padding: 10px; }
        .category_header { display: flex; align-items: center; justify-content: center; margin-bottom: 10px; font-weight: bold; }
        .category_list { max-height: calc(100vh - 200px); overflow-y: auto; }
        .icon { margin-right: 5px; font-size: 18px; }
        .category_item { display: flex; align-items: center; width: 100%; padding: 8px 10px; margin-bottom: 6px; background-color: #eee; border-radius: 6px; cursor: pointer; }
        .category_item:hover, .category_item.selected { background-color: #ddd; }
        .memo_list_container { padding-left: 20px; }
        .memo_item { padding: 4px 8px; cursor: pointer; border-radius: 4px; margin-top: 4px; }
        .memo_item:hover { background-color: #f0f0f0; }
        .memo_date { font-size: 0.8em; color: #777; margin-left: 8px; }
        .center { width: 70%; background-color: #fff8dc; display: flex; flex-direction: column; padding: 20px; }
        .note_header { display: flex; align-items: center; justify-content: space-between; background-color: #ffff88; padding: 10px; border-radius: 8px 8px 0 0; }
        .title_input { flex: 1; margin-right: 10px; padding: 5px; border: 1px solid #ccc; border-radius: 4px; background-color: #fff8dc; }
        .note_body { flex: 1; padding: 20px; overflow-y: auto; border-right: 1px solid #ddd; border-left: 1px solid #ddd; }
        .note_body textarea { width: 100%; height: 100%; resize: none; border: none; outline: none; background-color: transparent; }
        .note_footer { position: relative; padding: 10px; background-color: #ffff88; border-radius: 0 0 8px 8px; display: flex; justify-content: center; align-items: center; }
        .arrow_group { position: absolute; left: 10px; }
        .file_attachment { position: absolute; right: 10px; }
        .right { width: 15%; background-color: #fff; border-left: 2px solid #bbb; padding: 5px; display: flex; flex-direction: column; gap: 8px; }
        .right button { width: 100%; margin-top: 10px; margin-bottom: 10px; padding: 12px; border: none; border-radius: 8px; cursor: pointer; text-align: center; height: 48px; }
        .home_btn { background-color: #4CAF50; color: #fff; }
        .memo_add_btn { background-color: #888; color: #fff; }
        .delete_btn { background-color: #f44336; color: #fff; }
        .quicknote { width: 100%; height: 300px; background-color: #ffff88; border-radius: 8px; padding: 10px; }
        .quicknote_header { font-weight: bold; margin-bottom: 5px; }
        .quicknote_input { width: 100%; height: 250px; resize: none; border: none; outline: none; background-color: transparent; }
    </style>
</head>
<body>
    <header>
        <h1><a href="login_success.jsp">myMemo</a></h1>
        <div class="search_box">
            <input type="text" placeholder="Í≤ÄÏÉâÏñ¥Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî...">
            <button>Í≤ÄÏÉâ</button>
        </div>
    </header>
    <hr style="margin:0">
    <div class="layout" id="mainLayout">
        <div class="left">
            <div class="user_info">
                <h3><a href="#">üë§ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥</a></h3>
                <div class="user_nickname"><%= nickname %>Îãò, ÌôòÏòÅÌï©ÎãàÎã§!</div>
            </div>
            <div class="left_panel_content">
                <div class="category">
                    <div class="category_header">
                        <span>üóÇÔ∏èÏπ¥ÌÖåÍ≥†Î¶¨</span>
                        <form name="categoryForm" action="add_category_proc.jsp" method="post" style="display:inline;">
                            <input type="hidden" name="categoryName" id="categoryNameInput">
                            <input type="hidden" name="memberIdx" value="<%= memberIdx %>">
                            <button type="button" id="addCategoryBtn" class="add_list_btn">‚ûï</button>
                        </form>
                    </div>
                    <div class="category_list">
                        <%-- ### 2. Ïπ¥ÌÖåÍ≥†Î¶¨ Î™©Î°ù DBÏóêÏÑú Î∂àÎü¨ÏôÄ ÌëúÏãú ### --%>
                        <%
                            for (String[] category : categoryList) {
                                String listIdx = category[0];
                                String listName = category[1];
                                String memoCount = category[2]; // Î©îÎ™® Í∞úÏàò Î≥ÄÏàò
                                String selectedClass = (selectedCategoryId_str != null && listIdx.equals(selectedCategoryId_str)) ? "selected" : "";
                        %>
                                <a href="login_success.jsp?categoryId=<%= listIdx %>" class="category_item <%= selectedClass %>">
                                    <span class="category_name">
                                        <span class="icon">üìÇ</span>
                                        <span><%= listName %></span>
                                    </span>
                                    <span class="memo_count">(<%= memoCount %>)</span>
                                </a>
                        <%
                            }
                        %>
                    </div>

                    <%-- ### 3. Î©îÎ™® Î™©Î°ù DBÏóêÏÑú Î∂àÎü¨ÏôÄ ÌëúÏãú ### --%>
                    <%
                        if (selectedCategoryId_str != null) {
                    %>
                        <div class="memo_list_container">
                            <h4>Î©îÎ™® Î™©Î°ù</h4>
                    <%
                     		try {
                                String memoSql = "SELECT idx, title, is_important FROM memo WHERE list_idx = ? ORDER BY created_at DESC";
                                pstmt = con.prepareStatement(memoSql);
                                pstmt.setInt(1, Integer.parseInt(selectedCategoryId_str));
                                rs = pstmt.executeQuery();
                                while (rs.next()) {
                                    String importantMark = "Y".equals(rs.getString("is_important")) ? "‚≠ê" : "";
                                    int memoId = rs.getInt("idx");
                                    String selectedMemoClass = (selectedMemoId_str != null && memoId == Integer.parseInt(selectedMemoId_str)) ? "selected" : "";
                    %>
                                    <div class="memo_item <%= selectedMemoClass %>" onclick="location.href='login_success.jsp?categoryId=<%=selectedCategoryId_str%>&memoId=<%=memoId%>'">
                                        <%= importantMark %> <%= rs.getString("title") %>
                                    </div>
                    <%
                                }
                            } catch (Exception e) {
                                e.printStackTrace();
                                out.println("Î©îÎ™® Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•ò.");
                            } finally {
                                if (rs != null) try { rs.close(); } catch (Exception e) {}
                                if (pstmt != null) try { pstmt.close(); } catch (Exception e) {}                              
                            }
                    %>
                        </div>
                    <%}%>
                </div>
            </div>
        </div>
        
        <%-- ### 4. Î©îÎ™® ÎÇ¥Ïö© ÌëúÏãú ### --%>
        <%
            String memoTitle = "";
            String memoContent = "";
            String memoIsImportant = "N";
            String memoBackgroundColor = "default";
            String memoFileName = "";
            
            if (selectedMemoId_str != null) {
                try {
                    String sql = "SELECT * FROM memo WHERE idx = ?";
                    pstmt = con.prepareStatement(sql);
                    pstmt.setInt(1, Integer.parseInt(selectedMemoId_str));
                    rs = pstmt.executeQuery();
                    if (rs.next()) {
                        memoTitle = rs.getString("title");
                        memoContent = rs.getString("memo");
                        memoIsImportant = rs.getString("is_important");
                        memoBackgroundColor = rs.getString("backgroundColor");
                        memoFileName = rs.getString("fileName");
                    }
                } catch (Exception e) {
                    e.printStackTrace();
                } finally {
                    if (rs != null) try { rs.close(); } catch (Exception e) {}
                    if (pstmt != null) try { pstmt.close(); } catch (Exception e) {}
                    if (con != null) try { con.close(); } catch (Exception e) {}
                }
            }
        %>
        
        <form name="memoForm" id="memoForm" class="center" action="add_memo_proc.jsp" method="POST" enctype="multipart/form-data">
            <input type="hidden" name="list_idx" id="selectedListIdx">
            <input type="hidden" name="memoIdx" id="memoIdx" value="<%= selectedMemoId_str != null ? selectedMemoId_str : "" %>">
            <div class="note_header">
                <input type="text" name="title" class="title_input" placeholder="Ï†úÎ™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" value="<%= memoTitle %>">
                <label>Ï§ëÏöî:
                    <select name="is_important" id="isImportantSelect">
                        <option value="N" <%= "N".equals(memoIsImportant) ? "selected" : "" %>>N</option>
                        <option value="Y" <%= "Y".equals(memoIsImportant) ? "selected" : "" %>>Y</option>
                    </select>
                </label>
                <label>Î∞∞Í≤ΩÏÉâ:
                    <select name="backgroundColor" id="memoColorSelect">
                        <option value="default" <%= "default".equals(memoBackgroundColor) ? "selected" : "" %>>Í∏∞Î≥∏</option>
                        <option value="skyBlue" <%= "skyBlue".equals(memoBackgroundColor) ? "selected" : "" %>>ÌïòÎäòÏÉâ</option>
                        <option value="Yellow"  <%= "Yellow".equals(memoBackgroundColor) ? "selected" : "" %>>ÎÖ∏ÎûÄÏÉâ</option>
                    </select>
                </label>
                <label>Ïπ¥ÌÖåÍ≥†Î¶¨:
                 <select name="list_idx" id="categorySelect">
                     <%
                         if (categoryList.isEmpty()) {
                     %>
                             <option value="">Ïπ¥ÌÖåÍ≥†Î¶¨Î•º ÎßåÎì§Ïñ¥Ï£ºÏÑ∏Ïöî</option>
                     <%
                         } else {
                             for (String[] category : categoryList) {
                     %>
                                 <option value="<%= category[0] %>"><%= category[1] %> (<%= category[2] %>)</option>
                     <%
                             }
                         }
                     %>
                 </select>
             </label>
            </div>
            <div class="note_body">
                <textarea name="memo" placeholder="Î©îÎ™® ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."><%= memoContent %></textarea>
            </div>
            <div class="note_footer">
                <div class="arrow_group">
                    <button type="button">‚¨ÖÔ∏è</button><span>1/1</span><button type="button">‚û°Ô∏è</button>
                </div>
                <div class="file_attachment">
                    <label for="fileInput">Ï≤®Î∂Ä Í∑∏Î¶º:</label>
                    <input type="file" name="fileName" id="fileInput">
                    <% if (memoFileName != null && !memoFileName.isEmpty()) { %>
                        <span id="currentFileName">(ÌòÑÏû¨ ÌååÏùº: <%= memoFileName %>)</span>
                    <% } %>
                </div>
            </div>
        </form>
        <div class="right">
            <button class="home_btn" onclick="location.href='login_success.jsp'">üè† Ìôà</button>
            <button id="addMemoBtn" type="button" class="memo_add_btn">‚ûï ÏÉà Î©îÎ™® Ï†ÄÏû•</button>
            <button id="updateMemoBtn" class="memo_add_btn" style="display:none;">‚úèÔ∏è Î©îÎ™® ÏàòÏ†ï</button>
            <button id="deleteMemoBtn" class="delete_btn">üóëÔ∏è ÏÇ≠Ï†úÌïòÍ∏∞</button>
            <div class="quicknote">
                <div class="quicknote_header">üìå Í∞ÑÌé∏ Î©îÎ™®Ïû•</div>
                <textarea class="quicknote_input" placeholder="ÎÇ¥Ïö© ÏûÖÎ†•..."></textarea>
            </div>
        </div>
    </div>
    <div id="categorySelectOverlay" class="category-select-overlay">Ï†ÄÏû•Ìï† Ïπ¥ÌÖåÍ≥†Î¶¨Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</div>

<script>
    // Ï†ÑÏó≠ Î≥ÄÏàòÎ°ú ÌòÑÏû¨ ÏÉÅÌÉúÎ•º Í¥ÄÎ¶¨

    // Ïπ¥ÌÖåÍ≥†Î¶¨ Ï∂îÍ∞Ä Î≤ÑÌäº Ïù¥Î≤§Ìä∏
    document.addEventListener('DOMContentLoaded', function() {
        const addBtn = document.getElementById('addCategoryBtn');
        addBtn.addEventListener('click', function() {
            const name = prompt("Ï∂îÍ∞ÄÌï† ÏÉà Ïπ¥ÌÖåÍ≥†Î¶¨Ïùò Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:");
            if (name && name.trim() !== "") {
                document.getElementById('categoryNameInput').value = name;
                document.categoryForm.submit();
            } else if (name !== null) {
                alert("Ïπ¥ÌÖåÍ≥†Î¶¨ Ïù¥Î¶ÑÏù¥ ÏûÖÎ†•ÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.");
            }
        });
    });

    // Î©îÎ™® Ï∂îÍ∞Ä Î≤ÑÌäº Ïù¥Î≤§Ìä∏
    // login_success.jspÏùò <script> ÌÉúÍ∑∏ Ïïà
// ...

// Î©îÎ™® Ï∂îÍ∞Ä Î°úÏßÅ
document.getElementById('addMemoBtn').addEventListener('click', function() {
    // 1. memoFormÏùÑ Í∞ÄÏ†∏ÏòµÎãàÎã§.
    const form = document.forms.memoForm;
    const title = form.title.value.trim();
    const content = form.memo.value.trim();
    const categorySelect = form.list_idx;

    // 2. Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨ (Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ†ÌÉù Ïó¨Î∂Ä, Ï†úÎ™©/ÎÇ¥Ïö© ÏûÖÎ†• Ïó¨Î∂Ä)
    if (categorySelect.value === "") {
        alert("Ï†ÄÏû•Ìï† Ïπ¥ÌÖåÍ≥†Î¶¨Í∞Ä ÏóÜÏäµÎãàÎã§. Ïπ¥ÌÖåÍ≥†Î¶¨Î•º Î®ºÏ†Ä ÎßåÎì§Ïñ¥Ï£ºÏÑ∏Ïöî.");
        return;
    }
    if (title === "" || content === "") {
        alert("Ï†úÎ™©Í≥º ÎÇ¥Ïö©ÏùÑ Î®ºÏ†Ä ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
        return;
    }

    // 3. Î™®Îì† Ï°∞Í±¥Ïù¥ ÎßåÏ°±ÌïòÎ©¥ formÏùÑ actionÏóê ÏßÄÏ†ïÎêú "add_memo_proc.jsp"Î°ú Ï†úÏ∂úÌï©ÎãàÎã§.
    form.submit();
});
</script>
</body>
</html>